#!/bin/bash

# Copyright(c) Microsoft Corporation.
# Licensed under the MIT License.

# Git pre-push hook for OneMCP project
# This hook runs code quality checks before allowing a push

set -euo pipefail

#==================================================================================================
# Constants
#==================================================================================================

PROJECT_ROOT=$(git rev-parse --show-toplevel)
SCRIPTS_DIR=${PROJECT_ROOT}/scripts

#==================================================================================================
# Imports
#==================================================================================================

source "${SCRIPTS_DIR}/utils.sh"

#==================================================================================================
# Functions
#==================================================================================================

# Function to run a check and handle errors
run_check() {
  local check_name="$1"
  local command="$2"

  print_status "Running $check_name..."
  if eval "$command"; then
    print_success "$check_name passed"
  else
    print_error "$check_name failed"
    echo "Fix the issues above before pushing."
    exit 1
  fi
}

#==================================================================================================
# Main Script
#==================================================================================================

echo "üîç Running pre-push checks..."

# Check if virtual environment exists and activate it
activate_virtualenv

# 1. Code formatting check
run_check "code formatting" "ruff format --check src tests"

# 2. Linting
run_check "linting" "ruff check src tests"

# 3. Type checking
run_check "type checking" "mypy src"

# 4. Tests
run_check "tests" "pytest"

print_success "All pre-push checks passed! üéâ"
echo "Push proceeding..."
